---
title: Coronavirus
author: ~
date: '2020-07-17'
slug: coronavirus
categories: []
tags: []
---

https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide

```{r setup, include=FALSE, message=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
```

Libraries, reading in of the data and light tidying.

```{r}
library(tidyverse)
library(lubridate)
library(httr)
library(zoo)
library(plotly)
library(dplyr)
library(ggrepel)
library(gganimate)
library(gifski)
library(transformr)
library(tidyr)


theme_set(theme_minimal())

covid_raw <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", na.strings = "", fileEncoding = "UTF-8-BOM") %>% 
  rename("date" = dateRep,
         "country" = countriesAndTerritories,
         "code" = countryterritoryCode,
         "population2019" = popData2019,
         "continent" = continentExp,
         "cases_rate" = Cumulative_number_for_14_days_of_COVID.19_cases_per_100000)
```

Defining of the G8 and G20 nations

```{r}
#covid_data <- read.csv("covid_data.csv")

G8 <- c("FRA","DEU","ITA","JPN","GBR","USA","RUS","CDN")

G20 <- c("ARG","BRA","AUS","CAN","CHN","FRA","DEU","IND","IDN","ITA","JPN","KOR","MEX","RUS","SAU","ZAF","TUR","GBR","USA")


```

Getting the data ready for use.

```{r}
covid <- covid_raw %>%
  mutate(date=dmy(date),
         country= case_when(
           country == "United_Kingdom" ~ "UK",
           country == "United_States_of_America" ~ "USA",
           TRUE ~ country
         )) %>% 
  mutate(country = sub("_"," ",country)) %>% 
  filter(cases_rate>0)
```

Creating dataframes specific to G8 and G20 nations.

```{r}
covid_g8 <- covid %>% 
  filter(code %in% c(G8))

covid_g20 <- covid %>% 
  filter(code %in% c(G20)) %>% 
  mutate(day = (date - min(covid$date))) %>%
  group_by(date) %>% 
  mutate(day = as.integer(parse_number(toString(day))))

uk_critical_dates <-
  tibble(
    date = ymd(""),
    date.1 = 0,
    day = 0,
    month = 0,
    year = 0,
    cases = 0,
    deaths = 0,
    country = "",
    geold = "",
    code = "",
    population2019 = "",
    continent = "",
    cases_rate = 0,
    label = ""
  )



#%>%
#        select({{y}}),
add_uk_critical_date <- function(date01,country01,label01){
  g <-
    data.frame(
      date = ymd(date01),
      covid_g20 %>%
        filter(date == ymd(date01),
               country==country01),
      label = label01
    )
  colnames(g) <- colnames(uk_critical_dates)
  uk_critical_dates<<- rbind(uk_critical_dates,g,deparse.level = 1)
}



uk_critical_dates
add_uk_critical_date(20200323,country="UK",label = "Initial lockdown")
add_uk_critical_date(20200717,country="UK",label = "Non-essential travel")
add_uk_critical_date(20200717,country="UK",label = "Leisure centres open")
add_uk_critical_date(20200525,country="USA",label = "Protests")
uk_critical_dates <- uk_critical_dates %>% 
  filter(!is.na(date)) %>% 
  select(-date.1)
```


Plotting our graphs.

```{r}
covid_g8 %>% ### Keep
  ggplot(aes(date, cases_rate, colour = country))+
  geom_line()+
  theme(legend.position = "bottom")+
  labs(colour = "Country Code",
       x="",
       y="No. cases per 100,000 people",
       title = "Active covid-19 cases per 100,000 people in the G8")+
  scale_x_date(date_breaks = "1 month", date_minor_breaks = "1 week",
             date_labels = "%B")


covid_g20 %>% ### Keep
  filter(country == "UK") %>%
  ggplot(aes(date, cases_rate)) +
  geom_line() +
  labs(
    title = "UK cases per 100,000 people",
    subtitle = paste("Current rate is ", round(
      covid %>% filter(country == "UK") %>% select(cases_rate) %>% head(1),
      2
    )," / ", "Points show significant lockdown changes"),
    x = "",
    y = "No. cases per 100,000 people"
  ) +
  geom_point(data = uk_critical_dates %>% filter(country=="UK"), aes(date,cases_rate), colour = "red",shape=18,size=4)+
  geom_text_repel(data = uk_critical_dates %>% filter(country=="UK"),aes(x=date, y=cases_rate, label=label))+
  scale_x_date(date_breaks = "1 month", date_minor_breaks = "1 week",
             date_labels = "%B")+
  scale_y_continuous(breaks = seq(0,max(covid$cases_rate),10))+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor.x = element_blank())



covid_g20 %>% ### Keep
  filter(country == "USA") %>%
  ggplot(aes(date, cases_rate)) +
  geom_line() +
  labs(
    title = "USA cases per 100,000 people",
    subtitle = paste("Current rate is ", round(
      covid %>% filter(country == "USA") %>% select(cases_rate) %>% head(1),
      2
    )," / ", "Points show significant lockdown changes"),
    x = "",
    y = "No. cases per 100,000 people"
  ) +
  geom_point(data = uk_critical_dates %>% filter(country=="USA"), aes(date,cases_rate), colour = "red",shape=18,size=4)+
  geom_text_repel(data = uk_critical_dates %>% filter(country=="USA"),aes(x=date, y=cases_rate, label=label))+
  scale_x_date(date_breaks = "1 month", date_minor_breaks = "1 week",
             date_labels = "%B")+
  scale_y_continuous(breaks = seq(0,max(covid$cases_rate),10))+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor.x = element_blank())

covid_g20 %>% ### Keep
  filter(country=="USA") %>% 
  ggplot(aes(date, cases_rate))+
  geom_line()+
  labs(title = "USA cases per 100,000 people",
       subtitle = paste("Current rate is ", round(covid %>% filter(country=="USA") %>% select(cases_rate) %>% head(1),2)))


plt_g20 <- covid_g20 %>% 
  ggplot(aes(day, cases_rate,colour = country))+
    geom_line()+
  theme(legend.position = "none")+
  labs(colour = "Country Code",
       x="",
       y="No. cases per 100,000 people",
       title = "Active covid-19 cases per 100,000 people in the G20",
       caption = "Source: opendata.ecdc.europa.eu/covid19/")


ggplotly(
  covid_g20 %>%
    ggplot(aes(date, cases_rate, colour = country)) +
    geom_line() +
    theme(legend.position = "bottom") +
    geom_vline(xintercept = ymd(20200525)) +
  labs(
    colour = "Country Code",
    x = "",
    y = "No. cases per 100,000 people",
    title = "Active covid-19 cases per 100,000 people in the G20"
  )
)



```


